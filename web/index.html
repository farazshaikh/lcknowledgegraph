<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Graph Visualization</title>
    <script src="https://unpkg.com/cytoscape@3.23.0/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #header {
            padding: 10px 20px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #ddd;
        }
        #cy {
            flex-grow: 1;
            width: 100%;
            border: 1px solid #ccc;
        }
        .controls {
            padding: 10px;
            display: flex;
            gap: 10px;
        }
        #search {
            padding: 5px;
            width: 300px;
        }
        #layout-select {
            padding: 5px;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Knowledge Graph</h1>
        <div class="controls">
            <input type="text" id="search" placeholder="Search for a concept...">
            <select id="layout-select">
                <option value="dagre">Dagre (Hierarchical)</option>
                <option value="circle">Circle</option>
                <option value="grid">Grid</option>
                <option value="concentric">Concentric</option>
                <option value="breadthfirst">Breadth First</option>
                <option value="cose">Force-Directed (CoSE)</option>
                <option value="random">Random</option>
            </select>
            <button id="reset">Reset View</button>
        </div>
    </div>
    <div id="cy"></div>

    <script>
        window.onload = function() {
            console.log('Page loaded, fetching graph data...');

            fetch('./graph.json')
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Graph data loaded:', data);

                    // Register the dagre layout
                    cytoscape.use(cytoscapeDagre);

                    // Initialize cytoscape
                    const cy = cytoscape({
                        container: document.getElementById('cy'),
                        elements: data,
                        style: [
                            {
                                selector: 'node',
                                style: {
                                    'label': 'data(label)',
                                    'text-valign': 'center',
                                    'text-halign': 'center',
                                    'background-color': '#6FB1FC',
                                    'text-outline-width': 2,
                                    'text-outline-color': '#fff',
                                    'color': '#000'
                                }
                            },
                            {
                                selector: 'edge',
                                style: {
                                    'width': 2,
                                    'line-color': '#ccc',
                                    'target-arrow-color': '#ccc',
                                    'target-arrow-shape': 'triangle',
                                    'curve-style': 'bezier'
                                }
                            },
                            {
                                selector: '.highlighted',
                                style: {
                                    'background-color': '#ff7f0e',
                                    'line-color': '#ff7f0e',
                                    'target-arrow-color': '#ff7f0e',
                                    'transition-property': 'background-color, line-color, target-arrow-color',
                                    'transition-duration': '0.5s'
                                }
                            }
                        ],
                        layout: {
                            name: 'circle', // Start with a simple layout
                            padding: 30
                        }
                    });

                    // Make cy available globally for the layout selector
                    window.cy = cy;

                    // Function to apply selected layout
                    function applyLayout(layoutName) {
                        let layoutOptions = {
                            name: layoutName,
                            padding: 30
                        };

                        // Add specific options for certain layouts
                        if (layoutName === 'dagre') {
                            /*
                            layoutOptions.rankDir = 'TB';
                            layoutOptions.nodeSep = 50;
                            layoutOptions.rankSep = 100;
                            */
                        } else if (layoutName === 'breadthfirst') {
                            layoutOptions.spacingFactor = 1.5;
                            layoutOptions.animate = true;
                            layoutOptions.fit = true;
                            layoutOptions.circle = false;
                            layoutOptions.grid = true;
                        } else if (layoutName === 'concentric') {
                            layoutOptions.minNodeSpacing = 50;
                        } else if (layoutName === 'cose') {
                            layoutOptions.idealEdgeLength = 100;
                        }
                        cy.layout(layoutOptions).run();
                    }

                    // Add search functionality
                    const searchInput = document.getElementById('search');
                    searchInput.addEventListener('input', function() {
                        const query = this.value.toLowerCase();

                        // Reset all styles
                        cy.elements().removeClass('highlighted');

                        if (query.length > 2) {
                            // Find matching nodes
                            const matchingNodes = cy.nodes().filter(node => {
                                return node.data('label').toLowerCase().includes(query);
                            });

                            if (matchingNodes.length > 0) {
                                // Highlight matching nodes
                                matchingNodes.addClass('highlighted');
                                matchingNodes.connectedEdges().addClass('highlighted');
                            }
                        }
                    });

                    // Layout selection change event
                    const layoutSelect = document.getElementById('layout-select');
                    layoutSelect.addEventListener('change', function() {
                        applyLayout(this.value);
                    });

                    // Reset button
                    document.getElementById('reset').addEventListener('click', function() {
                        cy.elements().removeClass('highlighted');
                        searchInput.value = '';
                        cy.fit();

                        // Reset layout selector to dagre
                        layoutSelect.value = 'dagre';
                        
                        // Apply dagre layout
                        applyLayout('dagre');
                    });

                    // Double-click to focus on a node
                    cy.on('dblclick', 'node', function(evt) {
                        const node = evt.target;
                        cy.elements().removeClass('highlighted');
                        node.addClass('highlighted');
                        node.connectedEdges().addClass('highlighted');

                        // Center on the selected node
                        cy.animate({
                            center: { eles: node },
                            zoom: 1.5,
                            duration: 500
                        });
                    });

                    // Apply dagre layout after initial rendering
                    setTimeout(() => {
                        applyLayout('dagre');
                    }, 100);
                })
                .catch(error => {
                    console.error('Error loading graph data:', error);
                });
        };
    </script>
</body>
</html>
